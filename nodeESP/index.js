const express = require('express');
const bodyParser = require('body-parser');
const path = require('path');
const getRawBody = require('raw-body');
const contentType = require('content-type');

var PORT = process.env.port || 5000;

var app = express()

app.disable('x-powered-by');
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
app.use(express.static(path.join(__dirname, 'public')));

// variables
var idmodewifi = '0';
var idssid = '';
var ispassword = '';
var idipmode = '0';
var idip1 = '192';
var idip2 = '168';
var idip3 = '0';
var idip4 = '100';
var idmask1 = '255';
var idmask2 = '255';
var idmask3 = '255';
var idmask4 = '0';
var idrouter1 = '192';
var idrouter2 = '168';
var idrouter3 = '0';
var idrouter4 = '1';
var iddns1 = '8';
var iddns2 = '8';
var iddns3 = '8';
var iddns4 = '8';

app.get('/api/name',function(req,res)
{
    res.status(200).send("Esto es un ejemplo");
});

const index_html = Buffer.from([0x3C,0x21,0x44,0x4F,0x43,0x54,0x59,0x50,0x45,0x20,0x68,0x74,0x6D,0x6C,0x3E,0x3C,0x68,0x74,0x6D,0x6C,0x20,0x6C,0x61,0x6E,0x67,0x3D,0x22,0x65,0x6E,0x22,0x3E,0x3C,0x68,0x65,0x61,0x64,0x3E,0x20,0x3C,0x6D,0x65,0x74,0x61,0x20,0x63,0x68,0x61,0x72,0x73,0x65,0x74,0x3D,0x22,0x55,0x54,0x46,0x2D,0x38,0x22,0x3E,0x20,0x3C,0x6D,0x65,0x74,0x61,0x20,0x6E,0x61,0x6D,0x65,0x3D,0x22,0x76,0x69,0x65,0x77,0x70,0x6F,0x72,0x74,0x22,0x20,0x63,0x6F,0x6E,0x74,0x65,0x6E,0x74,0x3D,0x22,0x77,0x69,0x64,0x74,0x68,0x3D,0x64,0x65,0x76,0x69,0x63,0x65,0x2D,0x77,0x69,0x64,0x74,0x68,0x2C,0x20,0x69,0x6E,0x69,0x74,0x69,0x61,0x6C,0x2D,0x73,0x63,0x61,0x6C,0x65,0x3D,0x31,0x2E,0x30,0x22,0x3E,0x20,0x3C,0x6D,0x65,0x74,0x61,0x20,0x68,0x74,0x74,0x70,0x2D,0x65,0x71,0x75,0x69,0x76,0x3D,0x22,0x58,0x2D,0x55,0x41,0x2D,0x43,0x6F,0x6D,0x70,0x61,0x74,0x69,0x62,0x6C,0x65,0x22,0x20,0x63,0x6F,0x6E,0x74,0x65,0x6E,0x74,0x3D,0x22,0x69,0x65,0x3D,0x65,0x64,0x67,0x65,0x22,0x3E,0x20,0x3C,0x74,0x69,0x74,0x6C,0x65,0x3E,0x45,0x6A,0x65,0x6D,0x70,0x6C,0x6F,0x20,0x64,0x65,0x20,0x48,0x54,0x4D,0x4C,0x3C,0x2F,0x74,0x69,0x74,0x6C,0x65,0x3E,0x3C,0x2F,0x68,0x65,0x61,0x64,0x3E,0x3C,0x62,0x6F,0x64,0x79,0x3E,0x3C,0x63,0x65,0x6E,0x74,0x65,0x72,0x3E,0x20,0x3C,0x68,0x31,0x3E,0x45,0x73,0x74,0x6F,0x20,0x65,0x73,0x20,0x75,0x6E,0x61,0x20,0x70,0x72,0x75,0x65,0x62,0x61,0x3C,0x2F,0x68,0x31,0x3E,0x3C,0x2F,0x63,0x65,0x6E,0x74,0x65,0x72,0x3E,0x3C,0x2F,0x62,0x6F,0x64,0x79,0x3E,0x3C,0x2F,0x68,0x74,0x6D,0x6C,0x3E]);

app.get('/api/zo.html',function(req,res)
{
    res.set('Content-Type', 'text/html');
    res.send(index_html);
}); 

app.post('/api/write',function(req,res)
{
    getRawBody(req, 
        {
            length: req.headers['content-length'],
            limit: '1mb',
            encoding: contentType.parse(req).parameters.charset
        },function (err, str) 
        {
            if (err) 
                return next(err);

            valores = str.split(',');
            if(valores.length >= 20)
            {
                idmodewifi = valores[0];
                idssid = valores[1];
                ispassword = valores[2];
                idipmode = valores[3];
                idip1 = valores[4];
                idip2 = valores[5];
                idip3 = valores[6];
                idip4 = valores[7];
                idmask1 = valores[8];
                idmask2 = valores[9];
                idmask3 = valores[10];
                idmask4 = valores[11];
                idrouter1 = valores[12];
                idrouter2 = valores[13];
                idrouter3 = valores[14];
                idrouter4 = valores[15];
                iddns1 = valores[16];
                iddns2 = valores[17];
                iddns3 = valores[18];
                iddns4 = valores[19];

                res.set('Content-Type', 'text/plain');
                res.status(200).send("1");
            }
            else
            {
                res.set('Content-Type', 'text/plain');
                res.status(200).send("0");
            }


        });
});

app.post('/api/read',function(req,res)
{
    getRawBody(req, 
        {
            length: req.headers['content-length'],
            limit: '1mb',
            encoding: contentType.parse(req).parameters.charset
        },function (err, str) 
        {
            if (err) 
                return next(err);

            valores =   idmodewifi+','
                        +idssid+','
                        +ispassword+','
                        +idipmode+','
                        +idip1+','
                        +idip2+','
                        +idip3+','
                        +idip4+','
                        +idmask1+','
                        +idmask2+','
                        +idmask3+','
                        +idmask4+','
                        +idrouter1+','
                        +idrouter2+','
                        +idrouter3+','
                        +idrouter4+','
                        +iddns1+','
                        +iddns2+','
                        +iddns3+','
                        +iddns4;

            res.set('Content-Type', 'text/plain');
            res.status(200).send(valores);
        });
});

app.listen(PORT,function()
{
    console.log(`Servidor en Marcha http://127.0.0.1:${PORT}`);
});
